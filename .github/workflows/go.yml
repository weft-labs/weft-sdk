name: Go SDK

on:
  pull_request:
    paths:
      - "go/**"
      - "spec/**"
      - "scripts/**"
  push:
    branches: ["main"]
    tags: ["v*"]

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: go
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
      - name: Generate SDK
        run: ../scripts/generate-go.sh
      - name: Verify generated output
        run: ../scripts/test-sdk.sh
      - name: Test
        run: go test ./...

  # Go modules are published via git tags â€” no separate publish step needed.
  # Tag format: go/v0.2.0 (Go module path is github.com/weft-labs/weft-sdk/go)
  # After pushing a tag, pkg.go.dev will index the module automatically.
  tag-check:
    needs: build
    if: startsWith(github.ref, 'refs/tags/go/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
      - name: Verify module
        run: |
          cd go
          go mod verify
      - name: Trigger pkg.go.dev indexing
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          MODULE="github.com/weft-labs/weft-sdk/go@${TAG#go/}"
          curl -s "https://proxy.golang.org/${MODULE}/@v/${TAG#go/}.info" || true
